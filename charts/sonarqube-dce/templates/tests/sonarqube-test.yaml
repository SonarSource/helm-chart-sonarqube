{{- if .Values.tests.enabled -}}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-ui-test"
  annotations:
    "helm.sh/hook": test-success
  labels: {{- include "sonarqube.labels" . | nindent 4 }}
spec:
  automountServiceAccountToken: false
  {{- if or .Values.ApplicationNodes.image.pullSecrets .Values.ApplicationNodes.image.pullSecret }}
  imagePullSecrets:
    {{- with .Values.ApplicationNodes.image.pullSecret }}
    - name: {{ . }}
    {{- end }}
    {{- with .Values.ApplicationNodes.image.pullSecrets }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- end }}
  containers:
    - name: {{ .Release.Name }}-ui-test
      image: {{ default (include "sonarqube.image" $) .Values.tests.image | quote }}
      imagePullPolicy: {{ .Values.ApplicationNodes.image.pullPolicy }}
      command: ['wget']
      args: [
        '--retry-connrefused',
        '--waitretry=1',
        '--timeout=5',
        '-t',
        '1200',
        '-qO-',
        '{{ template "sonarqube.fullname" . }}:{{ .Values.service.internalPort }}/api/system/status'
        ]
      {{- with .Values.tests.resources }}
      resources: {{- toYaml . | nindent 8 }}
      {{- end }}
  restartPolicy: Never
{{- end -}}
